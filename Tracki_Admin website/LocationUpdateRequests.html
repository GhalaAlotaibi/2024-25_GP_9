<!DOCTYPE html>
<html lang="en" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tracki - Ø·Ù„Ø¨Ø§Øª ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹</title>
    <link rel="stylesheet" href="Styles/Style.css" />
    <link rel="stylesheet" href="Styles/AllTrucks.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Zain:wght@400&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  </head>
  <body>
    <div class="main-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Header Section -->
        <div class="headerOfBar">
          <img src="images/TrackiLogo.png" alt="Logo" />
          <h1>Tracki</h1>
        </div>

        <!-- Navigation Links -->
        <ul style="list-style: none; padding: 0; margin: 20px 0">
          <li><a href="MainPage.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
          <li><a href="PendingTrucks.html"><i class="fas fa-truck-loading"></i> Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†ØªØ¸Ø§Ø±</a></li>
          <li><a href="AllTrucks.html"><i class="fas fa-truck"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø±Ø¨Ø§Øª</a></li>
          <li><a href="LocationUpdateRequests.html" style="background-color: #7a557a; color: #faf3f0; font-weight: bold; border-radius: 8px;"><i class="fas fa-map-marker-alt"></i> Ø·Ù„Ø¨Ø§Øª ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></li>
          <li><a href="History.html"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</a></li>
          <li><a href="Reviews.html"><i class="fas fa-star"></i> Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</a></li>
          <li><a href="Complaints.html"><i class="fas fa-exclamation-circle"></i> Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</a></li>          
        </ul>
      </div>

      <section class="status-section">
        <div class="left-actions">
          <p id="status">Ù…Ø±Ø­Ø¨Ù‹Ø§!</p>
        </div>
        <div class="right-actions">
          <i
            id="notification-icon"
            class="fas fa-bell notification-icon"
            title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"
          ></i>
          <i
            id="logout-icon"
            class="fas fa-sign-out-alt logout-icon"
            title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"
          ></i>
        </div>
      </section>

      <!-- Main Content -->
      <div class="content">
        <h2>Ø·Ù„Ø¨Ø§Øª ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
        <p style="margin: 20px 0"></p>
        <div class="table-container">
          <table id="location-update-table">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ø§Ù„Ùƒ</th>
                <th>Ù…ÙˆÙ‚Ø¹ Ù‚Ø¯ÙŠÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</th>
                <th>Ù…ÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</th>
                <th>Ù…Ù„Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ù‚Ø¨ÙˆÙ„/Ø§Ù„Ø±ÙØ¶</th>
              </tr>
            </thead>
            <tbody>
              <!-- Location update request rows will be added here dynamically -->
            </tbody>
          </table>

          <div
            id="pagination-controls"
            style="text-align: center; margin-top: 20px"
          ></div>
        </div>
        <!--  <div class="loading" id="loading-message">
          <img src="images/WaitingTruck2.png" alt="Loading Food Truck" />
          <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¥Ù†ØªØ¸Ø§Ø±...</p>
        </div> -->
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>ØªØ±Ø§ÙƒÙŠ 2025 Â©. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù„Ùƒ Ø³Ø¹ÙˆØ¯</p>
    </div>

    <!-- Firebase Script -->
    <!-- Firebase Script -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
        updateDoc,
        query,
        where,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBL6Y2okjMbi3EcqrBnaE-ky-KvOF7hVA8",
        authDomain: "trucki-database.firebaseapp.com",
        projectId: "trucki-database",
        storageBucket: "trucki-database.appspot.com",
        messagingSenderId: "283818817351",
        appId: "1:283818817351:web:bfa138d68f42dfc64c3e62",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // EmailJS Initialization
      (function () {
        emailjs.init("aSjH9uTGS9FjbZvje"); // Public key for EmailJS
      })();

      // Auth state change listener
      onAuthStateChanged(auth, (user) => {
        const statusElement = document.getElementById("status");
        if (user) {
          const username = user.email.split("@")[0];
          statusElement.innerText = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${username} !`;
          fetchLocationUpdateRequests(); // Fetch the location update requests
        } else {
          statusElement.innerText = "Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
          window.location.href = "WelcomePage.html";
        }
      });

      // Logout handler
      const logoutIcon = document.getElementById("logout-icon");
      logoutIcon.addEventListener("click", async () => {
        try {
          await signOut(auth);
          alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­!");
          window.location.href = "WelcomePage.html";
        } catch (error) {
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: " + error.message);
        }
      });

      // Fetch location update requests from Firestore
      async function fetchLocationUpdateRequests() {
        try {
          console.log("Fetching location update requests...");

          const querySnapshot = await getDocs(
            collection(db, "Location_Update")
          );
          console.log("Location update requests:", querySnapshot);

          if (querySnapshot.empty) {
            const locationUpdateTableBody = document.querySelector(
              "#location-update-table tbody"
            );
            locationUpdateTableBody.innerHTML = "";
            const noDataRow = document.createElement("tr");
            noDataRow.innerHTML = `<td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td>`;
            locationUpdateTableBody.appendChild(noDataRow);
            return;
          }

          const allRows = [];
          for (const docSnapshot of querySnapshot.docs) {
            const data = docSnapshot.data();
            console.log("Request data:", data);

            // Fetch owner details
            const ownerID = data.ownerID;
            const ownerDocRef = doc(db, "Truck_Owner", ownerID);
            const ownerDoc = await getDoc(ownerDocRef);
            const ownerName = ownerDoc.exists()
              ? ownerDoc.data().Name
              : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            const ownerEmail = ownerDoc.exists()
              ? ownerDoc.data().Email
              : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            const ownerPhone = ownerDoc.exists()
              ? ownerDoc.data().PhoneNum
              : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

            // Fetch old location
            const foodTruckQuerySnapshot = await getDocs(
              query(
                collection(db, "Food_Truck"),
                where("ownerID", "==", ownerID)
              )
            );
            let oldLatitude, oldLongitude;
            if (!foodTruckQuerySnapshot.empty) {
              const foodTruckDoc = foodTruckQuerySnapshot.docs[0];
              const data = foodTruckDoc.data();
              console.log("Food truck data:", data);
              const oldLocation = data.location;
              [oldLatitude, oldLongitude] = oldLocation.split(",");
            }

            // New location
            const newLatitude = data.latitude;
            const newLongitude = data.longitude;
            const locationUpdateFile = data.locationUpdateFile;

            // Google Maps Links
            const oldLocationMapUrl = `https://www.google.com/maps?q=${oldLatitude},${oldLongitude}`;
            const newLocationMapUrl = `https://www.google.com/maps?q=${newLatitude},${newLongitude}`;

            // Owner details HTML
            const ownerDetails = `
          <div class="owner-details">
            <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${ownerName}</p>
            <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${ownerEmail}</p>
            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${ownerPhone}</p>
          </div>
        `;
            const statusTranslations = {
              pending: "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
              accepted: "Ù…Ù‚Ø¨ÙˆÙ„",
              rejected: "Ù…Ø±ÙÙˆØ¶",
            };

            const statusText = statusTranslations[data.status] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";

            // Create table row
            const row = document.createElement("tr");
            row.innerHTML = `
          <td>${ownerDetails}</td>
          <td><a href="${oldLocationMapUrl}" target="_blank">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a></td>
          <td><a href="${newLocationMapUrl}" target="_blank">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a></td>
          <td><a href="${locationUpdateFile}" target="_blank">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù</a></td>
          <td>${statusText}</td>
          <td>
            <button class="accept-btn" data-id="${docSnapshot.id}" data-owner="${ownerEmail}" data-truck="${ownerID}" data-lat="${newLatitude}" data-long="${newLongitude}">Ù‚Ø¨ÙˆÙ„</button>
            <button class="reject-btn" data-id="${docSnapshot.id}" data-owner="${ownerEmail}">Ø±ÙØ¶</button>
          </td>
        `;

            allRows.push(row);
          }

          // Append rows to the table
          const locationUpdateTableBody = document.querySelector(
            "#location-update-table tbody"
          );
          allRows.forEach((row) => locationUpdateTableBody.appendChild(row));
        } catch (error) {
          console.error("Error fetching location update requests:", error);
        }
      }

      // Handle accept/reject actions
      document.addEventListener("click", async (event) => {
        if (
          event.target.classList.contains("accept-btn") ||
          event.target.classList.contains("reject-btn")
        ) {
          const requestId = event.target.dataset.id;
          const ownerEmail = event.target.dataset.owner;
          const ownerID2 = event.target.dataset.truck;
          const newLat = event.target.dataset.lat;
          const newLong = event.target.dataset.long;
          try {
            // Accept Action
            if (event.target.classList.contains("accept-btn")) {
              await updateDoc(doc(db, "Location_Update", requestId), {
                status: "accepted",
              });

              // Fetch the Food_Truck document using ownerID
              const foodTruckQuerySnapshot = await getDocs(
                query(
                  collection(db, "Food_Truck"),
                  where("ownerID", "==", ownerID2)
                )
              );

              if (foodTruckQuerySnapshot.empty) {
                console.error("Food truck not found for owner:", ownerEmail);
                return;
              }

              // Get the first matching document (since ownerID should be unique)
              const foodTruckDoc = foodTruckQuerySnapshot.docs[0];
              const foodTruckDocRef = foodTruckDoc.ref; // Reference to the food truck document

              // âœ… Update the food truck's location in the Food_Truck collection
              await updateDoc(foodTruckDocRef, {
                location: `${newLat},${newLong}`, // Set the new coordinates
              });
              await sendEmail(
                ownerEmail,
                "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ğŸšš",
                `ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø¹Ø±Ø¨ØªÙƒ!  
   Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯: https://www.google.com/maps?q=${newLat},${newLong}`
              );

              alert("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø§Ù„Ùƒ!");
            }

            // Reject Action
            if (event.target.classList.contains("reject-btn")) {
              const reason = prompt("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:");
              if (!reason) {
                alert("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶.");
                return;
              }

              await updateDoc(doc(db, "Location_Update", requestId), {
                status: "rejected",
                rejectionReason: reason,
              });
              await sendEmail(
                ownerEmail,
                "ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ âŒ",
                `Ù†Ø£Ø³ÙØŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø¹Ø±Ø¨ØªÙƒ. Ø§Ù„Ø³Ø¨Ø¨: ${reason}`
              );
              alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø§Ù„Ùƒ!");
            }

            // Reload the page to reflect the changes
            window.location.reload();
          } catch (error) {
            console.error("Error handling request:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨.");
          }
        }
      });

      // Function to send email via EmailJS
      async function sendEmail(toEmail, subject, message) {
        try {
          const response = await emailjs.send(
            "service_wsy344n",
            "template_oh87x8s",
            {
              to_email: toEmail,
              subject: subject,
              message: message,
            }
          );
          console.log("Email sent successfully:", response);
        } catch (error) {
          console.error("Error sending email:", error);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.");
        }
      }
    </script>
  </body>
</html>
